# Flex Message 開團功能說明

## 功能概述

已成功實現使用 Flex Message 和 Quick Reply 的現代化開團功能，提供更直觀、更友善的使用者體驗。

## 實現的功能

### 1. 新的開團指令
- **指令**: `!開團`
- **觸發方式**: 管理員在群組中輸入 `!開團`
- **功能**: 發送互動式 Flex Message 卡片

### 2. Flex Message 卡片功能
- **視覺化界面**: 美觀的卡片式設計
- **即時狀態更新**: 顯示已選擇的地點、時間、日期
- **互動按鈕**: 三個主要操作按鈕
  - 選擇地點
  - 選擇時間  
  - 確認開團

### 3. Quick Reply 快速選擇
- **地點選擇**: 顯示所有可用場館的快速回覆按鈕
- **時間選擇**: 提供常用時段的快速回覆按鈕
- **日期選擇**: 顯示未來7天的日期選項

### 4. 會話狀態管理
- **狀態保存**: 記住使用者的選擇
- **即時更新**: 選擇後立即更新卡片狀態
- **自動清理**: 完成開團後自動清除會話資料

## 使用流程

### 步驟 1: 開始開團
```
管理員輸入: !開團
系統回應: 發送 Flex Message 卡片
```

### 步驟 2: 選擇地點
```
點擊「選擇地點」按鈕
系統回應: 顯示場館 Quick Reply 選項
選擇場館: 點擊場館按鈕
系統回應: 更新卡片狀態，顯示已選擇的地點
```

### 步驟 3: 選擇時間
```
點擊「選擇時間」按鈕
系統回應: 顯示時間 Quick Reply 選項
選擇時間: 點擊時間按鈕
系統回應: 更新卡片狀態，顯示已選擇的時間
```

### 步驟 4: 選擇日期
```
點擊「選擇日期」按鈕
系統回應: 顯示日期 Quick Reply 選項
選擇日期: 點擊日期按鈕
系統回應: 更新卡片狀態，顯示已選擇的日期
```

### 步驟 5: 確認開團
```
點擊「確認開團」按鈕
系統回應: 創建活動並發送開團公告
```

## 技術實現

### 新增檔案
- `flexmessage.gs`: Flex Message 和 Quick Reply 處理模組

### 修改檔案
- `webhook.gs`: 新增 Postback 事件處理和 `!開團` 指令支援

### 核心功能
1. **Flex Message 創建**: `createEventCreationCard()`
2. **狀態更新**: `updateEventCreationCard()`
3. **Quick Reply 處理**: `handleLocationSelection()`, `handleTimeSelection()`, `handleDateSelection()`
4. **Postback 處理**: `handleFlexPostback()`
5. **會話管理**: `saveSessionData()`, `getSessionData()`, `clearSessionData()`
6. **活動創建**: `confirmEventCreation()`

## 使用者體驗優化

### 優點
- ✅ **零學習成本**: 點擊按鈕即可操作
- ✅ **視覺化引導**: 清楚顯示當前狀態
- ✅ **即時回饋**: 選擇後立即更新
- ✅ **錯誤防護**: 確保必要資訊完整
- ✅ **向下相容**: 保留原有指令系統

### 適用對象
- **銀髮族**: 簡單的按鈕操作
- **中年族群**: 快速完成設定
- **青年族群**: 現代化介面體驗
- **管理員**: 更直觀的開團流程

## 測試功能

### 測試指令
```javascript
// 在 Apps Script 編輯器中執行
testFlexCreateEvent();
```

### 測試內容
- Flex Message 卡片創建
- 場館資料載入
- 會話資料管理
- 功能完整性驗證

## 注意事項

### 權限要求
- 僅限群組管理員可使用 `!開團` 指令
- 非管理員會收到權限不足的提示

### 資料管理
- 會話資料使用 Google Apps Script Properties 儲存
- 完成開團後自動清除會話資料
- 支援多使用者同時使用

### 錯誤處理
- 缺少必要資訊時會提示使用者
- 創建活動失敗時會顯示錯誤訊息
- 所有錯誤都會記錄到日誌系統

## 未來擴展

### 可能的改進
1. **更多時間選項**: 根據群組設定提供客製化時間
2. **場館篩選**: 根據地區或類型篩選場館
3. **快速模板**: 儲存常用的開團設定
4. **批量操作**: 一次創建多個活動

### 整合建議
- 可與現有的群組設定功能整合
- 支援個人化偏好設定
- 加入活動提醒功能

## 總結

Flex Message 開團功能成功實現了現代化的使用者體驗，大幅降低了開團的學習成本和操作複雜度。透過視覺化的卡片界面和直觀的按鈕操作，讓各年齡層的使用者都能輕鬆完成開團設定。

此功能完全向下相容，不會影響現有的指令系統，為羽球人系統帶來了更友善、更現代化的互動方式。
